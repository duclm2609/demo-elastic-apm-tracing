version: "3.7"

services:
  micro-inventory:
    build:
      context: ./micro-inventory-service
    container_name: micro-inventory
    volumes:
      - micro-inventory-log:/app/micro-inventory-service/logs
    networks:
      - micro-demo

  micro-price:
    build:
      context: ./micro-price-service
    container_name: micro-price
    env_file: ./micro-price-service/.env
    volumes:
      - micro-price-log:/var/logs
    networks:
      - micro-demo

  micro-review:
    build:
      context: ./micro-review-service
    container_name: micro-review
    env_file: ./micro-review-service/.env
    volumes:
      - micro-review-log:/var/logs
    networks:
      - micro-demo

  micro-api-gateway:
    build:
      context: ./micro-api-gateway
    container_name: micro-api-gateway
    env_file: ./micro-api-gateway/.env
    volumes:
      - micro-api-gateway-log:/var/logs
    networks:
      - micro-demo
    ports:
      - "8710:8080"

  filebeat:
    image: docker.elastic.co/beats/filebeat:7.5.0
    container_name: filebeat
    environment:
      - TZ=Asia/Ho_Chi_Minh
    command: --strict.perms=false -e
    volumes:
      - ./filebeat/inputs.d/:/usr/share/filebeat/inputs.d/:ro
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - micro-inventory-log:/var/logs/micro-inventory/
      - micro-api-gateway-log:/var/logs/micro-api-gateway/
      - micro-price-log:/var/logs/micro-price
      - micro-review-log:/var/logs/micro-review
    networks:
      - micro-demo

  logstash:
    image: docker.elastic.co/logstash/logstash:7.5.0
    container_name: logstash
    environment:
      - TZ=Asia/Ho_Chi_Minh
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/config/pipeline
      - ./logstash/pipelines.yml:/usr/share/logstash/config/pipelines.yml
      - ./logstash/logstash.yml:/usr/share/logstash/config/logstash.yml
    networks:
      - micro-demo

networks:
  micro-demo:

volumes:
  micro-inventory-log:
  micro-api-gateway-log:
  micro-price-log:
  micro-review-log: